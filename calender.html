<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/bootstrap.css">
    <style>
        .custom-border {
            border-top: 2.5px solid coral;
            border-bottom: 2px solid coral;
            color: rgb(1, 19, 80);
        }

        #list li {
            list-style-type: none;
        }

        #list li::before {
            content: "<> ";

            color: chocolate;
        }

        .row-cols-7>* {
            flex: 0 0 auto;
            width: 14.2857142857%;
        }

        .bg-date {
            background-color: rgb(91, 202, 193);
        }


        #calender [id^="d_"] {
            cursor: pointer;
            text-align: left;
            height: 150px;
            background: #f2f3b3;
        }

        .badge-hour {
            display: inline-block;
            background-color: #f0ad4e;
            /* 橙色背景 */
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            /* 圓角 */
            font-size: 0.8rem;
            margin-bottom: 2px;
        }
    </style>
</head>

<body>
    <header class="fixed-top container-fluid bg-info custom-border py-3 " style="color: rgb(1, 19, 80);">
        <div class="fw-bold fs-4 ms-5">行事曆</div>
    </header>
    <!-- #modal -->
    <div class="modal" id="mList" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modal-date"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="show" class="mb-3"></div>
                    <button type="button" id="add" class="btn btn-success" style="display: none;"
                        data-bs-dismiss="modal" onclick="addPage(document.getElementById('modal-date'))">新增</button>
                    <button type="button" id="update" class="btn btn-info" style="display: none;"
                        data-bs-dismiss="modal" onclick="updatePage(document.getElementById('modal-date'))">更新</button>
                    <button type="button" id="delete" class="btn btn-danger" style="display: none;"
                        data-bs-dismiss="modal" onclick="deletePage(document.getElementById('modal-date'))">刪除</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">離開</button>
                </div>
            </div>
        </div>
    </div>
    <!-- delete modal -->
    <div class="modal" id="mDelete" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger">
                    <h5 class="modal-title text-white">刪除</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="dList"></div>

                </div>
                <div class="modal-footer">
                    <button type="button" id="dButton" class="btn btn-danger " onclick="deleteList()"
                        data-date="">確定</button>

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">離開</button>
                </div>
            </div>
        </div>
    </div>
    <!-- add modal -->
    <div class="modal" id="mAdd" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content ">
                <div class="modal-header bg-success">
                    <h5 class="modal-title text-white">新增</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">日期</label>
                        <input type="text" id="addDate" class="form-control" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="addHour" class="form-label">時間</label>
                        <input type="time" id="addHour" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="addTask" class="form-label">事項</label>
                        <input type="text" id="addTask" class="form-control">
                    </div>



                </div>
                <div class="modal-footer">
                    <button type="button" id="addButton" class="btn btn-success" onclick="addList()"
                        data-date="">確定</button>

                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">離開</button>
                </div>
            </div>
        </div>
    </div>
    <!-- update modal -->
    <div class="modal" id="mUpdate" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <h5 class="modal-title">更新</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 固定顯示日期 -->
                    <div class="mb-3">
                        <label class="form-label">日期</label>
                        <input type="text" id="updateDate" class="form-control" readonly>
                    </div>

                    <!-- 下拉選單顯示該日的 task -->
                    <div class="mb-3">
                        <label for="updateSelect" class="form-label">選擇待辦事項</label>
                        <select id="updateSelect" class="form-select" onchange="loadTaskForUpdate()">
                            <!-- JS 動態生成 option -->
                        </select>
                    </div>

                    <!-- 修改時間 -->
                    <div class="mb-3">
                        <label for="updateHour" class="form-label">時間</label>
                        <input type="time" id="updateHour" class="form-control">
                    </div>

                    <!-- 修改事項 -->
                    <div class="mb-3">
                        <label for="updateTask" class="form-label">事項</label>
                        <input type="text" id="updateTask" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" id="updateButton" class="btn btn-success" onclick="updateList()" data-date=""
                        data-id="">
                        確定
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">離開</button>
                </div>
            </div>
        </div>
    </div>

    <main class="container-fluid  " style="background-color: #f1dcd4; height: 130vh;">

        <div class="row h-100 ">

            <div class="col-3 h-100">
                <div class="mt-5 mb-2">&nbsp;</div>

                <div id="list" class="p-3">
                    <div class="accordion" id="calendarAccordion">
                        <!-- 今天 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingToday">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseToday" aria-expanded="true" aria-controls="collapseToday">
                                    今天
                                </button>
                            </h2>
                            <div id="collapseToday" class="accordion-collapse collapse show"
                                aria-labelledby="headingToday" data-bs-parent="#calendarAccordion">
                                <div id="today" class="accordion-body">

                                </div>
                            </div>
                        </div>

                        <!-- 明天 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingTomorrow">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseTomorrow" aria-expanded="false"
                                    aria-controls="collapseTomorrow">
                                    明天
                                </button>
                            </h2>
                            <div id="collapseTomorrow" class="accordion-collapse collapse"
                                aria-labelledby="headingTomorrow" data-bs-parent="#calendarAccordion">
                                <div id="tomorrow" class="accordion-body">

                                </div>
                            </div>
                        </div>

                        <!-- 本月 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingMonth">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseMonth" aria-expanded="false" aria-controls="collapseMonth">
                                    本月
                                </button>
                            </h2>
                            <div id="collapseMonth" class="accordion-collapse collapse" aria-labelledby="headingMonth"
                                data-bs-parent="#calendarAccordion">
                                <div id=tMonth class="accordion-body">

                                </div>
                            </div>
                        </div>

                        <!-- 其它 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header" id="headingOther">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapseOther" aria-expanded="false" aria-controls="collapseOther">
                                    其它
                                </button>
                            </h2>
                            <div id="collapseOther" class="accordion-collapse collapse" aria-labelledby="headingOther"
                                data-bs-parent="#calendarAccordion">
                                <div id="other" class="accordion-body">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-9 h-100  justify-content-center" style="background-color: #ece4bf;">
                <div class="mt-5 mb-2">&nbsp;</div>
                <div class="container mt-4">
                    <!-- 年份月份控制区 -->
                    <div class="row">
                        <div class="col-12 d-flex justify-content-center align-items-center bg-light p-2 border gap-3">
                            <!-- 年份输入 -->
                            <label for="year" class="fw-bold">年份：</label>
                            <input type="number" id="year" class="form-control w-auto" value="2025" min="1900"
                                max="2100">

                            <!-- 月份输入 -->
                            <label for="month" class="fw-bold">月份：</label>
                            <input type="number" id="month" class="form-control w-auto" value="12" min="1" max="12">
                        </div>
                    </div>

                    <!-- 日期区 -->
                    <div class="row row-cols-7 text-center mt-3" id="calender">
                        <div class="col fw-bold  bg-date py-2">日</div>
                        <div class="col fw-bold  bg-date py-2">一</div>
                        <div class="col fw-bold  bg-date py-2">二</div>
                        <div class="col fw-bold  bg-date py-2">三</div>
                        <div class="col fw-bold  bg-date py-2">四</div>
                        <div class="col fw-bold  bg-date py-2">五</div>
                        <div class="col fw-bold  bg-date py-2">六</div>

                        <div class="col border p-3">1</div>
                        <div class="col border p-3">2</div>
                        <div class="col border p-3">3</div>
                        <!-- 依序填滿 -->

                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="./js/bootstrap.js"></script>
    <script>
        let toDoList = [];
        let d = new Date();

        const today = new Date();
        today.setHours(0, 0, 0, 0); // 修正：設為 00:00:00

        const tomorrow = new Date();
        tomorrow.setDate(today.getDate() + 1);
        tomorrow.setHours(0, 0, 0, 0); // 修正：設為 00:00:00
        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, "0");
            const d = String(date.getDate()).padStart(2, "0");
            return `${y}-${m}-${d}`;
        }


        toDoList.push(
            { id: 1, date: formatDate(today), hour: "09:00", task: "買菜" },
            { id: 1, date: formatDate(tomorrow), hour: "10:00", task: "繳水費" },

            { id: 1, date: "2025-12-25", hour: "11:00", task: "運動" },
            { id: 3, date: "2025-12-25", hour: "13:00", task: "運動" },
            { id: 2, date: "2025-12-25", hour: "12:00", task: "打掃" },
            { id: 1, date: "2025-12-27", hour: "13:00", task: "看書" },
            { id: 1, date: "2025-12-28", hour: "14:00", task: "買水果" },
            { id: 1, date: "2025-12-29", hour: "15:00", task: "洗衣服" },
            { id: 1, date: "2025-12-30", hour: "16:00", task: "倒垃圾" },
            { id: 1, date: "2026-01-05", hour: "17:00", task: "煮晚餐" },
            { id: 1, date: "2026-01-06", hour: "18:00", task: "散步" }
        );

        toDoList.sort((a, b) => {
            const dateTimeA = new Date(`${a.date}T${a.hour}`);
            const dateTimeB = new Date(`${b.date}T${b.hour}`);
            return dateTimeA - dateTimeB;
        })
        console.log(toDoList);
        function makeList() {

            // 不要只抓未來，應該全部都要
            let data = toDoList.filter(a => new Date(a.date) >= today);


            let tDay = document.getElementById("today");
            let tmDay = document.getElementById("tomorrow");
            let tMonth = document.getElementById("tMonth");
            let other = document.getElementById("other");

            // 清空旧内容
            tDay.innerHTML = "";
            tmDay.innerHTML = "";
            tMonth.innerHTML = "";
            other.innerHTML = ""; // 修正：otherDay 改為 other

            // 遍歷任務並分類
            data.forEach(item => {
                let li = document.createElement("li");
                li.textContent = `${item.date} ${item.hour} - ${item.task}`;

                let taskDate = new Date(item.date);
                taskDate.setHours(0, 0, 0, 0);

                if (taskDate.getTime() === today.getTime()) {
                    // 今天的任務
                    tDay.appendChild(li);
                } else if (taskDate.getTime() === tomorrow.getTime()) {
                    // 明天的任務
                    console.log(item);
                    tmDay.appendChild(li);
                } else if (
                    taskDate.getMonth() === today.getMonth() &&
                    taskDate.getFullYear() === today.getFullYear()
                ) {
                    // 本月的任務
                    tMonth.appendChild(li);
                } else {
                    // 其他時間的任務
                    other.appendChild(li); // 修正：otherDay 改為 other
                }
            });
        }
        makeList();
        function renderCalendar() {
            const year = parseInt(document.getElementById("year").value);
            const month = parseInt(document.getElementById("month").value);
            const calendar = document.getElementById("calender");

            // 清除旧的日期格子（保留前 7 个星期标题）
            while (calendar.children.length > 7) {
                calendar.removeChild(calendar.lastChild);
            }

            const daysInMonth = new Date(year, month, 0).getDate();
            const firstDay = new Date(year, month - 1, 1).getDay();

            // 前面補空格
            for (let i = 0; i < firstDay; i++) {
                const empty = document.createElement("div");
                empty.className = "col  p-3";
                calendar.appendChild(empty);
            }

            // 填入日期
            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement("div");
                cell.className = "col border p-3 border-dark";
                cell.textContent = d;
                calendar.appendChild(cell);
                cell.id = `d_${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;

            }
            // 後面補空格
            // 計算總格子數（前面空格 + 日期）
            const totalCells = firstDay + daysInMonth;
            // 計算最後一週剩餘的空格數
            const remaining = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);

            for (let i = 0; i < remaining; i++) {
                const empty = document.createElement("div");
                empty.className = "col border p-3";
                calendar.appendChild(empty);
            }
            toDoList.filter(item =>
                new Date(item.date).getFullYear() === year &&
                new Date(item.date).getMonth() + 1 === month
            ).forEach(ev => {
                console.log(ev);
                const cell = document.getElementById(`d_${ev.date}`);
                if (cell) {
                    // 建立一個容器 div，包住時間和任務
                    const rowDiv = document.createElement("div");
                    rowDiv.className = "event-row";

                    // 時間標籤
                    const hourDiv = document.createElement("div");
                    hourDiv.className = "badge-hour me-2";
                    hourDiv.textContent = ev.hour;

                    // 任務文字
                    const taskDiv = document.createElement("span");
                    taskDiv.className = "small text-muted";
                    taskDiv.textContent = ` ${ev.task}`;

                    // 合併並加入格子
                    rowDiv.appendChild(hourDiv);
                    rowDiv.appendChild(taskDiv);
                    cell.appendChild(rowDiv);
                }

            });
            document.querySelectorAll('[id^="d_"]').forEach(el => {
                el.addEventListener("click", () => {

                    let date = el.id.slice(2); // 例如 d_2025-12-17
                    const modal = new bootstrap.Modal(document.getElementById("mList"));
                    document.getElementById("modal-date").innerText = date;
                    document.getElementById("show").innerHTML = ""

                    let todayList = toDoList.filter(list => date === list.date);
                    console.log(todayList);
                    let l = todayList.length;
                    if (l > 0) {
                        document.getElementById("delete").style.display = "inline-block";
                        document.getElementById("update").style.display = "inline-block";
                    } else {
                        document.getElementById("delete").style.display = "none";
                        document.getElementById("update").style.display = "none";

                    }
                    if (l < 3) {
                        document.getElementById("add").style.display = "inline-block";

                    } else {
                        document.getElementById("add").style.display = "none";
                    }





                    todayList.forEach(ev => {
                        const rowDiv = document.createElement("div");
                        rowDiv.className = "event-row";
                        const hourDiv = document.createElement("div");
                        hourDiv.className = "badge-hour me-2";
                        hourDiv.textContent = ev.hour;

                        // 任務文字
                        const taskDiv = document.createElement("span");
                        taskDiv.className = "small text-muted";
                        taskDiv.textContent = ` ${ev.task}`;

                        // 合併並加入格子
                        rowDiv.appendChild(hourDiv);
                        rowDiv.appendChild(taskDiv);
                        document.getElementById("show").appendChild(rowDiv);
                    });

                    modal.show();
                });
            });

        }
        function renew() {
            toDoList.sort((a, b) => {
                const dateTimeA = new Date(`${a.date}T${a.hour}`);
                const dateTimeB = new Date(`${b.date}T${b.hour}`);
                return dateTimeA - dateTimeB;
            })
            renderCalendar(
            );
            makeList();

        }
        function loadTaskForUpdate() {
            const date = document.getElementById("updateDate").value;
            const id = Number(document.getElementById("updateSelect").value);

            const item = toDoList.find(it => it.date === date && it.id === id);
            if (item) {
                document.getElementById("updateHour").value = item.hour;
                document.getElementById("updateTask").value = item.task;

                // 存到按鈕 dataset
                const btn = document.getElementById("updateButton");
                btn.dataset.date = item.date;
                btn.dataset.id = item.id;
            }
        }


        function addPage(el) {
            let date = el.innerText;

            const modal = new bootstrap.Modal(document.getElementById("mAdd"));

            document.getElementById("addDate").value = date;
            document.getElementById("addButton").dataset.date = date;
            document.getElementById("addHour").value="";
            document.getElementById("addTask").value="";

            modal.show()


        }
        function deletePage(el) {
            let date = el.innerText;

            const modal = new bootstrap.Modal(document.getElementById("mDelete"));
            let str = "";
            console.log(date);


            toDoList
                .filter(item => item.date === date)
                .forEach((item) => {
                    str += `
        <label for="task${item.id}">
          <input type="checkbox" id="task${item.id}" name="task${item.id}" value="${item.id}">
          ${item.date} ${item.hour} ${item.task}
        </label><br>
      `;

                });
            document.getElementById("dList").innerHTML = str;
            document.getElementById("dButton").dataset.date = date;

            modal.show()


        }
        function updatePage(el) {
            let date = el.innerText;
            document.getElementById("updateSelect").innerHTML = "";


            const modal = new bootstrap.Modal(document.getElementById("mUpdate"));
            document.getElementById("updateDate").value = date;
            document.getElementById("updateButton").dataset.date = date;
            toDoList.filter(item => item.date === date).forEach(item => {
                document.getElementById("updateSelect").innerHTML += `<option value="${item.id}">${item.hour} - ${item.task} </option>`;
            });
            loadTaskForUpdate()


            modal.show()


        }

        function deleteList() {
            for (i = 1; i <= 3; i++) {
                if (!window.confirm("確定要刪除")) {
                    return
                }
            }

            const date = document.getElementById("dButton").dataset.date;
            console.log(date);

            const checkedBoxes = document.querySelectorAll("#dList input[type=checkbox]:checked");

            // 取出所有勾選的 id
            const idsToDelete = Array.from(checkedBoxes).map(cb => Number(cb.value));


            // 過濾掉勾選的項目
            toDoList = toDoList.filter(item => !(item.date === date && idsToDelete.includes(item.id)));



            console.log("刪除後的 toDoList:", toDoList);

            // 關閉 modal
            const modal = bootstrap.Modal.getInstance(document.getElementById("mDelete"));
            modal.hide();
            console.log(toDoList);
            renew();
        }


        function addList() {
            const date = document.getElementById("addButton").dataset.date;
            const hour = document.getElementById("addHour").value;
            const task = document.getElementById("addTask").value;

            if (!hour || !task) {
                alert("請輸入完整的時間與事項！");
                return;
            }
            if (task.length >= 10) {
                alert("請輸入十字以內事項！");
                return;

            }
            const usedIds = toDoList
                .filter(item => item.date === date)
                .map(item => item.id);

            // 用 for 從 1~3 找出可用 id
            let id = null;
            for (let i = 1; i <= 3; i++) {
                if (!usedIds.includes(i)) {
                    id = i;
                    break;
                }
            }

            if (id === null) {
                alert(`日期 ${date} 的 id 1~3 都已經被使用，不能再新增！`);
                return;
            }

            const newItem = {
                id: id,
                date: date,
                hour: hour,
                task: task
            };


            toDoList.push(newItem);
            console.log("新增後的 toDoList:", toDoList);
            renew();

            const modal = bootstrap.Modal.getInstance(document.getElementById("mAdd"));
            modal.hide();
        }
        function updateList() {
            const date = document.getElementById("updateButton").dataset.date;
            const id = Number(document.getElementById("updateButton").dataset.id);
            const hour = document.getElementById("updateHour").value;
            const task = document.getElementById("updateTask").value;

            if (!hour || !task) {
                alert("請輸入完整的時間與事項！");
                return;
            }
            if (task.length >= 10) {
                alert("請輸入十字以內事項！");
                return;
            }

            const item = toDoList.find(it => it.date === date && it.id === id);
            if (item) {
                item.hour = hour;
                item.task = task;
                console.log("更新後的 toDoList:", toDoList);
            }
            renew();

            const modal = bootstrap.Modal.getInstance(document.getElementById("mUpdate"));
            modal.hide();
        }




        // 初始渲染
        renderCalendar();

        // 監聽年份和月份變化
        document.getElementById("year").addEventListener("change", renderCalendar);
        document.getElementById("month").addEventListener("change", renderCalendar);

    </script>
</body>

</html>